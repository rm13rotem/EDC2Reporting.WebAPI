@model DataServices.SqlServerRepository.Models.CrfModels.CrfEntry

@{
    ViewData["Title"] = "Edit CRF Entry";
    var crfPage = ViewBag.CrfPage as DataServices.SqlServerRepository.Models.CrfModels.CrfPage;
    var formData = string.IsNullOrWhiteSpace(Model.FormDataJson) ? "{}" : Model.FormDataJson;
}

<h2>Edit: @crfPage.Name</h2>

<form asp-action="Edit" method="post">
    <input type="hidden" asp-for="Id" />
    <input type="hidden" asp-for="CrfPageId" />
    <input type="hidden" asp-for="StudyId" />
    <input type="hidden" asp-for="FormDataJson" />

    <div>
        @Html.Raw(crfPage.Html)
    </div>

    <button type="submit" class="btn btn-primary">Save Changes</button>
</form>

<script>
    var existingData = @Html.Raw(formData);

    // Pre-fill form
    for (var key in existingData) {
        var el = document.querySelector(`[name="${key}"]`);
        if (el) el.value = existingData[key];
    }

    // Collect data again on submit
    document.querySelector("form").addEventListener("submit", function (e) {
        var form = e.target;
        var data = {};
        new FormData(form).forEach((value, key) => data[key] = value);
        form.querySelector("input[name='FormDataJson']").value = JSON.stringify(data);
    });
</script>
