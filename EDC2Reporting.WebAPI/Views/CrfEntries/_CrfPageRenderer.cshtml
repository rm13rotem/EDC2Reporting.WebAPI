@model DataServices.SqlServerRepository.Models.CrfModels.CrfEntry

@{
    ViewData["Title"] = "Fill CRF";
    var crfPage = ViewBag.CrfPage as DataServices.SqlServerRepository.Models.CrfModels.CrfPage;
}

<h2>@crfPage.Name</h2>
<p>@crfPage.Description</p>

<form asp-action="Create" method="post">

    <input type="hidden" asp-for="CrfPageId" />
    <input type="hidden" asp-for="StudyId" />
    <input type="hidden" asp-for="InvestigatorId" />
    <input type="hidden" asp-for="PatientId" />
    <input type="hidden" asp-for="VisitId" />

    <div>
        <!-- Render the CRF Page Html (raw form HTML template) -->
        @Html.Raw(crfPage.Html)
    </div>

    <!-- Hidden field for JSON data -->
    <input type="hidden" asp-for="FormDataJson" />

    <button type="submit" class="btn btn-primary">Save</button>
</form>

@section Scripts {
    <script>
        // Before submit, gather form data into JSON and set FormDataJson
        document.querySelector("form").addEventListener("submit", function (e) {
            var form = e.target;
            var data = {};
            new FormData(form).forEach((value, key) => data[key] = value);
            form.querySelector("input[name='FormDataJson']").value = JSON.stringify(data);
        });
    </script>
}
