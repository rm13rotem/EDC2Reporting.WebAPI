@using DataServices.SqlServerRepository.Models
@using Microsoft.AspNetCore.Identity
@inject SignInManager<Investigator> SignInManager
@inject UserManager<Investigator> UserManager
@inject SessionLayer.ISessionWrapper SessionWrapper
@inject DataServices.SqlServerRepository.EdcDbContext Db

@{
    ViewData["Title"] = "Home Page";
}

<div class="text-center">
    <h1 class="display-4">Welcome</h1>
    <p>
        <a asp-action="DesignExperiment" class="btn btn-outline-primary">Design Experiment</a>
    </p>
    <p>
        <a asp-controller="Investigator" asp-action="Index" class="btn btn-outline-primary">Manage Users</a>
    </p>
    <p>
        <a asp-controller="Site" asp-action="Index" class="btn btn-outline-primary">
            Manage Sites (Medical Research Centers)</a>
    </p>
    <p>
        <a asp-controller="Experiments" asp-action="Create" class="btn btn-outline-primary">New Experiment (Study)</a>
    </p>
</div>

@* Bottom status panel: shows logged-in user + session selection (patient / experiment / visit) *@
<div class="container mt-4">
    @if (SignInManager.IsSignedIn(User))
    {
        var investigator = await UserManager.GetUserAsync(User);

        var isAdmin = await UserManager.IsInRoleAsync(investigator, "Admin");
        var isLeader = await UserManager.IsInRoleAsync(investigator, "ClinicalTrialLeader");

        var patientId = SessionWrapper.SelectedPatientId;
        var visitId = SessionWrapper.SelectedVisitId;
        var visitIndex = SessionWrapper.SelectedVisitIndex;
        var visitGroupId = SessionWrapper.SelectedVisitGroupId;

        var patient = patientId > 0 ? await Db.Patients.FindAsync(patientId) : null;
        var visit = visitId > 0 ? await Db.Visits.FindAsync(visitId) : null;
        var visitGroup = visitGroupId > 0 ? await Db.VisitGroups.FindAsync(visitGroupId) : null;

        <div class="alert alert-secondary small">
            <div><strong>Currently logged in:</strong> @investigator.FirstName @investigator.LastName</div>
            <div><strong>Phone:</strong> @(string.IsNullOrWhiteSpace(investigator.PhoneNumber) ? "n/a" : investigator.PhoneNumber)
                 &nbsp;&nbsp;
                 <strong>Email:</strong> @(string.IsNullOrWhiteSpace(investigator.Email) ? "n/a" : investigator.Email)
            </div>

            <div class="mt-2">
                <strong>Selected patient:</strong>
                @{
                    if (patient != null)
                    {
                        <text>@($"{patient.Name} (Id: {patient.Id})")</text>;
                    }
                    else
                    {
                        <text>None selected</text>;
                        <text> &nbsp;</text>
                        <a asp-controller="Patients" asp-action="Select" class="btn btn-sm btn-primary">Select Patient</a>

                        if (isAdmin)
                        {
                            <span class="text-muted ms-2">(Admin can select any patient)</span>
                        }
                        else if (isLeader)
                        {
                            <span class="text-muted ms-2">(You can select patients in your assigned experiment)</span>
                        }
                        else
                        {
                            <span class="text-muted ms-2">(You can select patients for your experiment only)</span>
                        }
                    }
                }
            </div>

            <div class="mt-2">
                <strong>Selected experiment / visit group:</strong>
                @{
                    if (visitGroup != null)
                    {
                        <text>@visitGroup.Name</text>;
                    }
                    else
                    {
                        <text>None selected</text>;
                        <text> &nbsp;</text>
                        <a asp-controller="Experiments" asp-action="Select" class="btn btn-sm btn-secondary">Select Experiment</a>

                        if (isAdmin)
                        {
                            <span class="text-muted ms-2">(Admin can select any experiment)</span>
                        }
                        else if (isLeader)
                        {
                            <span class="text-muted ms-2">(You are limited to your assigned experiment)</span>
                        }
                        else
                        {
                            <span class="text-muted ms-2">(You can select experiments only if assigned)</span>
                        }
                    }
                }
            </div>

            <div class="mt-2">
                <strong>Visit number (index):</strong> @(visitIndex > 0 ? visitIndex.ToString() : "None selected")
                &nbsp;&nbsp;
                <strong>Visit id:</strong> @(visitId > 0 ? visitId.ToString() : "None selected")
                &nbsp;&nbsp;
                <strong>Visit name:</strong> @(visit != null ? visit.Name : "None selected")
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-secondary small">No user signed in.</div>
    }
</div>
